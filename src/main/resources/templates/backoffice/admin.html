<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backoffice - Admin | JuledToys</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/admin.css?v=2.0" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <img
            src="/Imagenes/logo.png"
            alt="Juled Toys Logo"
            style="width: 32px; height: 32px; border-radius: 6px"
          />
          <h4 class="mb-0">JuledToys Admin</h4>
        </div>
      </div>
      <nav class="nav-menu">
        <!-- Enlace a página principal -->
        <div class="nav-item">
          <a
            href="/"
            class="nav-link"
            target="_blank"
            title="Ver página principal"
          >
            <i class="fas fa-home"></i>
            <span>Ir a la Tienda</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="/backoffice/admin" class="nav-link active">
            <i class="fas fa-boxes"></i>
            <span>Productos</span>
          </a>
        </div>
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/promociones}" class="nav-link">
            <i class="fas fa-tags"></i>
            <span>Promociones</span>
          </a>
        </div>

        <div class="nav-item">
          <a th:href="@{/backoffice/admin/usuarios}" class="nav-link">
            <i class="fas fa-users"></i>
            <span>Usuarios</span>
          </a>
        </div>

        <div class="nav-item">
          <a th:href="@{/backoffice/admin/clientes}" class="nav-link">
            <i class="fas fa-user-tie"></i>
            <span>Clientes</span>
          </a>
        </div>

        <div class="nav-item">
          <a th:href="@{/backoffice/admin/proveedores}" class="nav-link">
            <i class="fas fa-truck"></i>
            <span>Proveedores</span>
          </a>
        </div>

        <div class="nav-item">
          <a th:href="@{/backoffice/admin/pedidos}" class="nav-link">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
          </a>
        </div>
        
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/reportes}" class="nav-link">
            <i class="fas fa-chart-bar"></i>
            <span>Reportes</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            <span>Configuración</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <h2>
          <i class="fas fa-boxes"></i>
          Gestión de Productos
        </h2>
        <div class="breadcrumb">Dashboard / Productos / Gestión</div>
      </header>

      <div class="content-wrapper">
        <!-- Mensajes de notificación -->
        <div
          th:if="${mensaje}"
          class="alert"
          th:classappend="${tipoMensaje == 'success' ? 'alert-success' : 'alert-danger'}"
          role="alert"
        >
          <i
            th:class="${tipoMensaje == 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'}"
          ></i>
          <span th:text="${mensaje}"></span>
        </div>

        <!-- Stats Cards -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-box"></i>
              </div>
            </div>
            <div class="stat-value" th:text="${totalProductos}">0</div>
            <div class="stat-label">Total Productos</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-warehouse"></i>
              </div>
            </div>
            <div class="stat-value" th:text="${stockTotal}">0</div>
            <div class="stat-label">Stock Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
            </div>
            <div class="stat-value">
              S/ <span
                th:text="${#numbers.formatDecimal(valorTotalInventario, 0, 'COMMA', 2, 'POINT')}"
                >0.00</span>
            </div>
            <div class="stat-label">Valor Total Inventario</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
            </div>
            <div class="stat-value" th:text="${stockBajo}">0</div>
            <div class="stat-label">Stock Bajo</div>
          </div>
        </div>

        <!-- Products Table -->
        <!-- Search bar above header as requested -->
        <div class="mb-3">
          <form class="d-flex justify-content-center backoffice-search" method="get" th:action="@{/backoffice/admin}">
            <div class="input-group" style="width:100%;">
              <input id="input-buscar-backoffice" type="search" name="q" class="form-control" placeholder="Buscar productos..." aria-label="Buscar" th:value="${param.q}">
              <button id="btnLimpiarBusqueda" class="btn btn-outline-secondary" type="button" title="Limpiar búsqueda">
                <i class="fas fa-times"></i>
              </button>
              <button class="btn btn-outline-secondary" type="submit" title="Buscar">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- Header with title and actions (below search) -->
        <div class="table-header d-flex align-items-center justify-content-between gap-3">
          <h3 class="table-title">
            <i class="fas fa-list"></i>
            Lista de Productos
          </h3>
          <div class="d-flex gap-2 align-items-center">
            <div class="d-flex">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoProducto">
                <i class="fas fa-plus"></i> Nuevo Producto
              </button>
              <form id="formEliminarMultiple" th:action="@{/backoffice/admin/productos/eliminar-multiple}" method="post" onsubmit="return confirm('¿Eliminar los productos seleccionados? Esta acción es irreversible.')">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button id="btnEliminarMultiple" class="btn btn-danger" type="submit" disabled>
                  <i class="fas fa-trash"></i> Eliminar seleccionados
                </button>
              </form>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAll" /></th>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Descripción</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="p : ${productos}">
                  <td><input type="checkbox" name="productoIds" form="formEliminarMultiple" th:value="${p.id}" class="selectItem"/></td>
                  <td>
                    <strong th:text="${p.id}">#001</strong>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <div class="product-icon">
                          <span th:text="${#strings.substring(p.nombre, 0, 1)}"
                            >T</span
                          >
                        </div>
                      </div>
                      <div>
                        <div class="fw-bold" th:text="${p.nombre}">
                          Producto
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span
                      th:text="${#strings.length(p.descripcion) > 50 ? #strings.substring(p.descripcion, 0, 50) + '...' : p.descripcion}"
                      >Descripción del producto...</span
                    >
                  </td>
                  <td>
                    <span class="fw-bold text-success">S/ <span
                        th:text="${#numbers.formatDecimal(p.precio, 0, 'COMMA', 2, 'POINT')}"
                        >0.00</span></span>
                  </td>
                  <td>
                    <span class="fw-bold" th:text="${p.stock}">0</span>
                  </td>
                  <!-- lógica de estados! -->
                  <td>
                    <span
                      th:class="${p.stock > 6 ? 'badge badge-success' : (p.stock > 0 ? 'badge badge-warning' : 'badge badge-danger')}"
                      th:text="${p.stock > 6 ? 'En Stock' : (p.stock > 0 ? 'Stock Bajo' : 'Agotado')}"
                    >
                      En Stock
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button
                        class="btn btn-outline-primary btn-sm btn-editar"
                        title="Editar"
                        th:data-producto-id="${p.id}"
                      >
                        <i class="fas fa-edit"></i>
                      </button>
                      <button
                        class="btn btn-outline-danger btn-sm btn-eliminar"
                        title="Eliminar"
                        th:data-producto-id="${p.id}"
                        th:data-producto-nombre="${p.nombre}"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const selectAll = document.getElementById('selectAll');
              const items = document.querySelectorAll('.selectItem');
              const btnEliminar = document.getElementById('btnEliminarMultiple');

              function updateButton() {
                const anyChecked = Array.from(document.querySelectorAll('.selectItem')).some(i => i.checked);
                btnEliminar.disabled = !anyChecked;
              }

              selectAll?.addEventListener('change', function () {
                items.forEach(i => i.checked = selectAll.checked);
                updateButton();
              });

              items.forEach(i => i.addEventListener('change', updateButton));
            });
          </script>
      </div>
    </div>

    <!-- Modal Nuevo Producto -->
    <div class="modal fade" id="modalNuevoProducto" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-plus"></i>
              Nuevo Producto
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form th:action="@{/backoffice/admin/productos}" method="post">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="modal-body">
              <div class="mb-3">
                <label for="nombre" class="form-label"
                  >Nombre del Producto</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  name="nombre"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="categoria" class="form-label">Categoría</label>
                <select id="categoria" class="form-select">
                  <option value="">-- Seleccione --</option>
                  <option value="__new__">+ Crear nueva categoría...</option>
                  <th:block th:each="c : ${categorias}">
                    <option th:value="${c}" th:text="${c}"></option>
                  </th:block>
                </select>
                <input type="text" id="newCategoryInput" class="form-control mt-2" placeholder="Nombre de nueva categoría" style="display:none;" />
                <!-- Hidden field that will be sent to the server. JS sets it before submit -->
                <input type="hidden" name="categoria" id="hiddenCategoria" />
              </div>
              <div class="mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea
                  class="form-control"
                  id="descripcion"
                  name="descripcion"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="imagenUrl" class="form-label">URL de imagen</label>
                <input type="text" id="imagenUrl" name="imagenUrl" class="form-control" placeholder="Imagen (ruta o nombre)" />
              </div>
              <div class="mb-3">
                <label for="imagenUrl1" class="form-label">Imagen mini 1 (URL)</label>
                <input type="text" id="imagenUrl1" name="imagenUrl1" class="form-control" placeholder="Imagen mini 1" />
              </div>
              <div class="mb-3">
                <label for="imagenUrl2" class="form-label">Imagen mini 2 (URL)</label>
                <input type="text" id="imagenUrl2" name="imagenUrl2" class="form-control" placeholder="Imagen mini 2" />
              </div>
              <div class="mb-3">
                <label for="imagenUrl3" class="form-label">Imagen mini 3 (URL)</label>
                <input type="text" id="imagenUrl3" name="imagenUrl3" class="form-control" placeholder="Imagen mini 3" />
              </div>
              <!-- Preview de imágenes (Nuevo) -->
              <div class="mb-3">
                <label class="form-label">Preview de imágenes</label>
                <div class="d-flex gap-2">
                  <img id="previewImagen" src="" alt="Preview principal" style="width:100px;height:100px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="previewImagen1" src="" alt="Preview mini 1" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="previewImagen2" src="" alt="Preview mini 2" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="previewImagen3" src="" alt="Preview mini 3" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                </div>
              </div>
              <div class="mb-3">
                <label for="rating" class="form-label">Rating (1-5)</label>
                <select id="rating" name="rating" class="form-select">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="detalles" class="form-label">Detalles (lista separada por saltos)</label>
                <textarea id="detalles" name="detalles" class="form-control" rows="3" placeholder="Características, dimensiónes, material..."></textarea>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label for="precio" class="form-label">Precio</label>
                  <input
                    type="number"
                    class="form-control"
                    id="precio"
                    name="precio"
                    step="0.01"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="stock" class="form-label">Stock</label>
                  <input
                    type="number"
                    class="form-control"
                    id="stock"
                    name="stock"
                    min="0"
                    required
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Guardar Producto
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Editar Producto -->
    <div class="modal fade" id="modalEditarProducto" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit"></i>
              Editar Producto
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="formEditarProducto" method="post">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="modal-body">
              <div class="mb-3">
                <label for="editNombre" class="form-label"
                  >Nombre del Producto</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="editNombre"
                  name="nombre"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editDescripcion" class="form-label"
                  >Descripción</label
                >
                <textarea
                  class="form-control"
                  id="editDescripcion"
                  name="descripcion"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label for="editPrecio" class="form-label">Precio</label>
                  <input
                    type="number"
                    class="form-control"
                    id="editPrecio"
                    name="precio"
                    step="0.01"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="editStock" class="form-label">Stock</label>
                  <input
                    type="number"
                    class="form-control"
                    id="editStock"
                    name="stock"
                    min="0"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="editCategoria" class="form-label">Categoría</label>
                <select id="editCategoria" class="form-select">
                  <option value="">-- Seleccione --</option>
                  <option value="__new__">+ Crear nueva categoría...</option>
                  <th:block th:each="c : ${categorias}">
                    <option th:value="${c}" th:text="${c}"></option>
                  </th:block>
                </select>
                <input type="text" id="editNewCategoryInput" class="form-control mt-2" placeholder="Nombre de nueva categoría" style="display:none;" />
                <input type="hidden" name="categoria" id="hiddenEditCategoria" />
              </div>
              <div class="mb-3">
                <label for="editImagenUrl" class="form-label">URL de imagen</label>
                <input type="text" id="editImagenUrl" name="imagenUrl" class="form-control" placeholder="Imagen (ruta o nombre)" />
              </div>
              <div class="mb-3">
                <label for="editImagenUrl1" class="form-label">Imagen mini 1 (URL)</label>
                <input type="text" id="editImagenUrl1" name="imagenUrl1" class="form-control" placeholder="Imagen mini 1" />
              </div>
              <div class="mb-3">
                <label for="editImagenUrl2" class="form-label">Imagen mini 2 (URL)</label>
                <input type="text" id="editImagenUrl2" name="imagenUrl2" class="form-control" placeholder="Imagen mini 2" />
              </div>
              <div class="mb-3">
                <label for="editImagenUrl3" class="form-label">Imagen mini 3 (URL)</label>
                <input type="text" id="editImagenUrl3" name="imagenUrl3" class="form-control" placeholder="Imagen mini 3" />
              </div>
              <!-- Preview de imágenes (Editar) -->
              <div class="mb-3">
                <label class="form-label">Preview de imágenes</label>
                <div class="d-flex gap-2">
                  <img id="editPreviewImagen" src="" alt="Preview principal" style="width:100px;height:100px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="editPreviewImagen1" src="" alt="Preview mini 1" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="editPreviewImagen2" src="" alt="Preview mini 2" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                  <img id="editPreviewImagen3" src="" alt="Preview mini 3" style="width:70px;height:70px;object-fit:cover;display:none;border:1px solid #ddd;border-radius:6px;" />
                </div>
              </div>
              <div class="mb-3">
                <label for="editRating" class="form-label">Rating (1-5)</label>
                <select id="editRating" name="rating" class="form-select">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editDetalles" class="form-label">Detalles</label>
                <textarea id="editDetalles" name="detalles" class="form-control" rows="3" placeholder="Características, dimensiones, material..."></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Actualizar Producto
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Eliminación -->
    <div class="modal fade" id="modalEliminarProducto" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-danger">
              <i class="fas fa-exclamation-triangle"></i>
              Confirmar Eliminación
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              ¿Estás seguro de que deseas eliminar el producto
              <strong id="nombreProductoEliminar"></strong>?
            </p>
            <p class="text-muted">Esta acción no se puede deshacer.</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <form id="formEliminarProducto" method="post" class="form-inline">
              <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <button type="submit" class="btn btn-danger">
                <i class="fas fa-trash"></i>
                Eliminar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // Función para editar producto
      function editarProducto(id) {
        fetch(`/backoffice/admin/productos/${id}`)
          .then((response) => response.json())
          .then((producto) => {
            if (producto) {
              document.getElementById("editNombre").value = producto.nombre;
              document.getElementById("editDescripcion").value =
                producto.descripcion;
              document.getElementById("editPrecio").value = producto.precio;
              document.getElementById("editStock").value = producto.stock;
                  // set categoria and imagenUrl when available
                  if (producto.categoria) {
                    const sel = document.getElementById('editCategoria');
                    if (sel) sel.value = producto.categoria;
                  }
                  if (producto.imagenUrl) {
                    const imgIn = document.getElementById('editImagenUrl');
                    if (imgIn) imgIn.value = producto.imagenUrl;
                  }
                  if (producto.imagenUrl1) {
                    const i1 = document.getElementById('editImagenUrl1'); if (i1) i1.value = producto.imagenUrl1;
                  }
                  if (producto.imagenUrl2) {
                    const i2 = document.getElementById('editImagenUrl2'); if (i2) i2.value = producto.imagenUrl2;
                  }
                  if (producto.imagenUrl3) {
                    const i3 = document.getElementById('editImagenUrl3'); if (i3) i3.value = producto.imagenUrl3;
                  }
                  if (producto.rating != null) {
                    const r = document.getElementById('editRating'); if (r) r.value = producto.rating;
                  }
                  if (producto.detalles) {
                    const d = document.getElementById('editDetalles'); if (d) d.value = producto.detalles;
                  }

                  // actualizar previews con el id del producto como fallback
                  try {
                    updateEditPreviews(producto.id);
                  } catch (e) {
                    // ignore
                  }

              document.getElementById(
                "formEditarProducto"
              ).action = `/backoffice/admin/productos/${id}/editar`;

              // Ensure any previous modal instance is hidden and disposed to avoid backdrop/stuck state
              (function(){
                const modalEl = document.getElementById("modalEditarProducto");
                try{
                  const existing = bootstrap.Modal.getInstance(modalEl);
                  if (existing){ existing.hide(); existing.dispose(); }
                } catch(e){ /* ignore */ }
                const created = new bootstrap.Modal(modalEl);
                created.show();
              })();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al cargar los datos del producto");
          });
      }

      // Función para eliminar producto
      function eliminarProducto(id, nombre) {
        document.getElementById("nombreProductoEliminar").textContent = nombre;
        document.getElementById(
          "formEliminarProducto"
        ).action = `/backoffice/admin/productos/${id}/eliminar`;
        // Ensure previous instance disposed to avoid backdrop issues
        (function(){
          const modalEl = document.getElementById("modalEliminarProducto");
          try{
            const existing = bootstrap.Modal.getInstance(modalEl);
            if (existing){ existing.hide(); existing.dispose(); }
          } catch(e){ }
          new bootstrap.Modal(modalEl).show();
        })();
      }

      // Auto-hide alerts after 5 seconds
      setTimeout(function () {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach((alert) => {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        });
      }, 5000);

      // Event handlers for edit and delete buttons
      document.addEventListener("DOMContentLoaded", function () {
        // Handle edit buttons
        document.querySelectorAll(".btn-editar").forEach((button) => {
          button.addEventListener("click", function () {
            const productoId = this.getAttribute("data-producto-id");
            editarProducto(productoId);
          });
        });

        // Handle delete buttons
        document.querySelectorAll(".btn-eliminar").forEach((button) => {
          button.addEventListener("click", function () {
            const productoId = this.getAttribute("data-producto-id");
            const productoNombre = this.getAttribute("data-producto-nombre");
            eliminarProducto(productoId, productoNombre);
          });
        });

        // Category new creation UX - Nuevo Producto modal
        const categoriaSelect = document.getElementById('categoria');
        const newCategoryInput = document.getElementById('newCategoryInput');
        const hiddenCategoria = document.getElementById('hiddenCategoria');
        if (categoriaSelect) {
          categoriaSelect.addEventListener('change', function () {
            if (this.value === '__new__') {
              newCategoryInput.style.display = 'block';
            } else {
              newCategoryInput.style.display = 'none';
            }
          });
        }

        // Category new creation UX - Editar Producto modal
        const editCategoriaSelect = document.getElementById('editCategoria');
        const editNewCategoryInput = document.getElementById('editNewCategoryInput');
        const hiddenEditCategoria = document.getElementById('hiddenEditCategoria');
        if (editCategoriaSelect) {
          editCategoriaSelect.addEventListener('change', function () {
            if (this.value === '__new__') {
              editNewCategoryInput.style.display = 'block';
            } else {
              editNewCategoryInput.style.display = 'none';
            }
          });
        }

        // Before submitting Nuevo Producto form: set hiddenCategoria accordingly
        const modalNuevo = document.getElementById('modalNuevoProducto');
        if (modalNuevo) {
          const formNuevo = modalNuevo.querySelector('form');
          if (formNuevo) {
            formNuevo.addEventListener('submit', function () {
              const sel = categoriaSelect ? categoriaSelect.value : '';
              let toSend = sel;
              if (sel === '__new__' && newCategoryInput) {
                toSend = newCategoryInput.value || '';
              }
              if (hiddenCategoria) hiddenCategoria.value = toSend;
            });
          }
        }

        // Before submitting Editar Producto form: set hiddenEditCategoria accordingly
        const modalEditar = document.getElementById('modalEditarProducto');
        if (modalEditar) {
          const formEditar = modalEditar.querySelector('#formEditarProducto');
          if (formEditar) {
            formEditar.addEventListener('submit', function () {
              const sel = editCategoriaSelect ? editCategoriaSelect.value : '';
              let toSend = sel;
              if (sel === '__new__' && editNewCategoryInput) {
                toSend = editNewCategoryInput.value || '';
              }
              if (hiddenEditCategoria) hiddenEditCategoria.value = toSend;
            });
          }
        }

        // Image preview helpers
        function computeImageSrc(value, fallbackPath) {
          if (!value) return null;
          const v = value.trim();
          if (v === '') return null;
          // If starts with / or http(s) or protocol-relative //, return as-is
          if (v.startsWith('/') || v.startsWith('http') || v.startsWith('//')) return v;
          // treat as filename -> prefix folder
          return '/Imagenes/productos/' + v;
        }

        function setPreview(imgElement, src) {
          if (!imgElement) return;
          if (src) {
            imgElement.src = src;
            imgElement.style.display = '';
          } else {
            imgElement.src = '';
            imgElement.style.display = 'none';
          }
        }

        // Nuevo modal: live preview when typing URLs
        const inputImagen = document.getElementById('imagenUrl');
        const inputImagen1 = document.getElementById('imagenUrl1');
        const inputImagen2 = document.getElementById('imagenUrl2');
        const inputImagen3 = document.getElementById('imagenUrl3');
        const previewImagen = document.getElementById('previewImagen');
        const previewImagen1 = document.getElementById('previewImagen1');
        const previewImagen2 = document.getElementById('previewImagen2');
        const previewImagen3 = document.getElementById('previewImagen3');

        function updateCreatePreviews() {
          setPreview(previewImagen, computeImageSrc(inputImagen?.value));
          setPreview(previewImagen1, computeImageSrc(inputImagen1?.value));
          setPreview(previewImagen2, computeImageSrc(inputImagen2?.value));
          setPreview(previewImagen3, computeImageSrc(inputImagen3?.value));
        }

        if (inputImagen) inputImagen.addEventListener('input', updateCreatePreviews);
        if (inputImagen1) inputImagen1.addEventListener('input', updateCreatePreviews);
        if (inputImagen2) inputImagen2.addEventListener('input', updateCreatePreviews);
        if (inputImagen3) inputImagen3.addEventListener('input', updateCreatePreviews);

        // Editar modal: when producto loaded, set previews; also live update when editing values
        const editInputImagen = document.getElementById('editImagenUrl');
        const editInputImagen1 = document.getElementById('editImagenUrl1');
        const editInputImagen2 = document.getElementById('editImagenUrl2');
        const editInputImagen3 = document.getElementById('editImagenUrl3');
        const editPreviewImagen = document.getElementById('editPreviewImagen');
        const editPreviewImagen1 = document.getElementById('editPreviewImagen1');
        const editPreviewImagen2 = document.getElementById('editPreviewImagen2');
        const editPreviewImagen3 = document.getElementById('editPreviewImagen3');

        function updateEditPreviews(productIdFallback) {
          // For main image, if editInputImagen empty use Set fallback with productIdFallback
          const mainSrc = computeImageSrc(editInputImagen?.value) || (productIdFallback ? ('/Imagenes/Set/Set' + productIdFallback + '.png') : null);
          setPreview(editPreviewImagen, mainSrc);
          setPreview(editPreviewImagen1, computeImageSrc(editInputImagen1?.value));
          setPreview(editPreviewImagen2, computeImageSrc(editInputImagen2?.value));
          setPreview(editPreviewImagen3, computeImageSrc(editInputImagen3?.value));
        }

        if (editInputImagen) editInputImagen.addEventListener('input', () => updateEditPreviews(null));
        if (editInputImagen1) editInputImagen1.addEventListener('input', () => updateEditPreviews(null));
        if (editInputImagen2) editInputImagen2.addEventListener('input', () => updateEditPreviews(null));
        if (editInputImagen3) editInputImagen3.addEventListener('input', () => updateEditPreviews(null));
      });
      
      // Live search (AJAX) with debounce - replaces table rows without full page reload
      (function(){
        function debounce(fn, wait){
          let t;
          return function(...args){
            clearTimeout(t);
            t = setTimeout(()=>fn.apply(this,args), wait);
          };
        }

        function rebindRowActions(){
          // Rebind edit buttons
          document.querySelectorAll('.btn-editar').forEach(btn=>{
            if (btn._editHandler) btn.removeEventListener('click', btn._editHandler);
            const handler = function(){ const productoId = this.getAttribute('data-producto-id'); editarProducto(productoId); };
            btn._editHandler = handler;
            btn.addEventListener('click', handler);
          });

          // Rebind delete buttons
          document.querySelectorAll('.btn-eliminar').forEach(btn=>{
            if (btn._delHandler) btn.removeEventListener('click', btn._delHandler);
            const handler = function(){ const productoId = this.getAttribute('data-producto-id'); const productoNombre = this.getAttribute('data-producto-nombre'); eliminarProducto(productoId, productoNombre); };
            btn._delHandler = handler;
            btn.addEventListener('click', handler);
          });

          // Rebind selectAll and item checkboxes
          const selectAll = document.getElementById('selectAll');
          const btnEliminar = document.getElementById('btnEliminarMultiple');

          function updateButton(){
            const anyChecked = Array.from(document.querySelectorAll('.selectItem')).some(i => i.checked);
            if (btnEliminar) btnEliminar.disabled = !anyChecked;
          }

          if (selectAll){
            if (selectAll._handler) selectAll.removeEventListener('change', selectAll._handler);
            const sHandler = function(){ document.querySelectorAll('.selectItem').forEach(i => i.checked = this.checked); updateButton(); };
            selectAll._handler = sHandler;
            selectAll.addEventListener('change', sHandler);
          }

          document.querySelectorAll('.selectItem').forEach(i=>{
            if (i._handler) i.removeEventListener('change', i._handler);
            const it = function(){ updateButton(); };
            i._handler = it;
            i.addEventListener('change', it);
          });
        }

        async function performSearch(q){
          try{
            const url = new URL(window.location.href);
            if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
            // fetch the page and extract table body
            const res = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) throw new Error('Error en búsqueda');
            const text = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const newTbody = doc.querySelector('.table tbody');
            if (newTbody){
              const tbody = document.querySelector('.table tbody');
              tbody.innerHTML = newTbody.innerHTML;
              rebindRowActions();
            }
          }catch(err){
            console.error('Live search error:', err);
          }
        }

        document.addEventListener('DOMContentLoaded', function(){
          const input = document.getElementById('input-buscar-backoffice');
          if (input){
            input.addEventListener('input', debounce(function(e){ performSearch(e.target.value); }, 350));
          }
          // Clear button behavior
          const btnLimpiar = document.getElementById('btnLimpiarBusqueda');
          if (btnLimpiar && input){
            btnLimpiar.addEventListener('click', function(e){
              input.value = '';
              performSearch('');
              input.focus();
            });
          }
          // Esc key clears the search
          document.addEventListener('keydown', function(e){
            if (e.key === 'Escape' || e.key === 'Esc'){
              if (input && input.value !== ''){
                input.value = '';
                performSearch('');
                input.focus();
              }
            }
          });
          // ensure handlers bound on first load
          rebindRowActions();
        });
      })();
      // Global modal cleanup to avoid stuck backdrops / locked scrolling
      (function(){
        function cleanupModalBackdrops(){
          try{
            // Remove any backdrop elements
            document.querySelectorAll('.modal-backdrop').forEach(function(el){ el.remove(); });
          }catch(e){ /* ignore */ }
          try{ document.body.classList.remove('modal-open'); }catch(e){ /* ignore */ }
          try{ document.body.style.removeProperty('padding-right'); }catch(e){ /* ignore */ }
          try{ document.body.style.removeProperty('overflow'); }catch(e){ /* ignore */ }
          try{
            // Remove show class and aria-hidden from modals that are not actually visible
            document.querySelectorAll('.modal').forEach(function(m){
              if (!m.classList.contains('show')){
                m.style.display = 'none';
                m.removeAttribute('aria-modal');
                m.setAttribute('aria-hidden','true');
              }
            });
          }catch(e){ /* ignore */ }
        }

        // When any modal is fully hidden, ensure cleanup
        document.addEventListener('hidden.bs.modal', function(e){
          try{
            // Dispose the instance for the modal that was hidden
            const inst = bootstrap.Modal.getInstance(e.target);
            if (inst){ inst.dispose(); }
          }catch(er){ /* ignore */ }
          cleanupModalBackdrops();
          // Also schedule cleanup a bit later to cover race conditions
          setTimeout(cleanupModalBackdrops, 100);
          setTimeout(cleanupModalBackdrops, 300);
        });

        // Before showing a modal, dispose other modal instances and cleanup any stray backdrops
        document.addEventListener('show.bs.modal', function(e){
          try{
            document.querySelectorAll('.modal').forEach(function(m){
              if (m !== e.target){
                try{
                  const inst = bootstrap.Modal.getInstance(m);
                  if (inst){ inst.hide(); inst.dispose(); }
                }catch(er){ /* ignore */ }
              }
            });
          }catch(err){ /* ignore */ }
          cleanupModalBackdrops();
        });

        // For buttons or links that dismiss modals, ensure cleanup after a short delay
        document.addEventListener('click', function(e){
          const target = e.target;
          if (!target) return;
          // match data-bs-dismiss attribute or btn-close
          if (target.closest('[data-bs-dismiss="modal"]') || target.classList.contains('btn-close')){
            setTimeout(cleanupModalBackdrops, 50);
            setTimeout(cleanupModalBackdrops, 200);
          }
        });

        // Also run a cleanup on initial load in case previous state left stray backdrops
        document.addEventListener('DOMContentLoaded', function(){
          setTimeout(cleanupModalBackdrops, 50);
          setTimeout(cleanupModalBackdrops, 300);
        });
      })();
    </script>
  </body>
</html>

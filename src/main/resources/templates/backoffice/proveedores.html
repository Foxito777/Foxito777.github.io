<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proveedores - Backoffice | JuledToys</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/admin.css?v=2.0" />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
          <img
            src="/Imagenes/logo.png"
            alt="Juled Toys Logo"
            style="width: 32px; height: 32px; border-radius: 6px"
          />
          <h4 class="mb-0">JuledToys Admin</h4>
        </div>
      </div>
      <nav class="nav-menu">
        <div class="nav-item">
          <a href="/" class="nav-link" target="_blank" title="Ver página principal">
            <i class="fas fa-home"></i>
            <span>Ir a la Tienda</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="/backoffice/admin" class="nav-link">
            <i class="fas fa-boxes"></i>
            <span>Productos</span>
          </a>
        </div>
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/promociones}" class="nav-link">
            <i class="fas fa-tags"></i>
            <span>Promociones</span>
          </a>
        </div>
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/usuarios}" class="nav-link">
            <i class="fas fa-users"></i>
            <span>Usuarios</span>
          </a>
        </div>
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/clientes}" class="nav-link">
            <i class="fas fa-user-tie"></i>
            <span>Clientes</span>
          </a>
        </div>
        <div class="nav-item">
          <a th:href="@{/backoffice/admin/proveedores}" class="nav-link active">
            <i class="fas fa-truck"></i>
            <span>Proveedores</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-chart-bar"></i>
            <span>Reportes</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            <span>Configuración</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <h2>
          <i class="fas fa-truck"></i>
          Gestión de Proveedores
        </h2>
        <div class="breadcrumb">Dashboard / Proveedores / Gestión</div>
      </header>

      <div class="content-wrapper">
        <!-- Mensajes de notificación -->
        <div
          th:if="${mensaje}"
          class="alert"
          th:classappend="${tipoMensaje == 'success' ? 'alert-success' : 'alert-danger'}"
          role="alert"
        >
          <i
            th:class="${tipoMensaje == 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'}"
          ></i>
          <span th:text="${mensaje}"></span>
        </div>

        <!-- Stats Cards -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-truck"></i>
              </div>
            </div>
            <div class="stat-value" th:text="${totalProveedores}">0</div>
            <div class="stat-label">Total Proveedores</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="stat-value" th:text="${proveedoresActivos}">0</div>
            <div class="stat-label">Proveedores Activos</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-shopping-bag"></i>
              </div>
            </div>
            <div class="stat-value">
              <a th:href="@{/backoffice/admin/proveedores/compras}" class="text-decoration-none">Ver Compras</a>
            </div>
            <div class="stat-label">Gestión de Compras</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">
                <i class="fas fa-box-open"></i>
              </div>
            </div>
            <div class="stat-value">
              <a th:href="@{/backoffice/admin/proveedores/entregas}" class="text-decoration-none">Ver Entregas</a>
            </div>
            <div class="stat-label">Gestión de Entregas</div>
          </div>
        </div>

        <!-- Barra de búsqueda -->
        <div class="mb-3">
          <form class="d-flex justify-content-center backoffice-search" method="get" th:action="@{/backoffice/admin/proveedores}">
            <div class="input-group" style="width:100%;">
              <input id="input-buscar-proveedor" type="search" name="q" class="form-control" 
                     placeholder="Buscar por razón social, RUC o contacto..." aria-label="Buscar" th:value="${q}">
              <button id="btnLimpiarBusqueda" class="btn btn-outline-secondary" type="button" title="Limpiar búsqueda">
                <i class="fas fa-times"></i>
              </button>
              <button class="btn btn-outline-secondary" type="submit" title="Buscar">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- Header con acciones -->
        <div class="table-header d-flex align-items-center justify-content-between gap-3">
          <h3 class="table-title">
            <i class="fas fa-list"></i>
            Lista de Proveedores
          </h3>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor">
              <i class="fas fa-plus"></i> Nuevo Proveedor
            </button>
          </div>
        </div>

        <!-- Tabla de Proveedores -->
        <div class="table-container">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Razón Social</th>
                  <th>RUC</th>
                  <th>Contacto</th>
                  <th>Teléfono</th>
                  <th>Email</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:if="${#lists.isEmpty(proveedores)}">
                  <td colspan="8" class="text-center">No hay proveedores registrados</td>
                </tr>
                <tr th:each="prov : ${proveedores}">
                  <td th:text="${prov.id}">1</td>
                  <td th:text="${prov.razonSocial}">Proveedor S.A.C.</td>
                  <td th:text="${prov.ruc}">20123456789</td>
                  <td th:text="${prov.personaContacto ?: '-'}">Juan Pérez</td>
                  <td th:text="${prov.telefono ?: '-'}">987654321</td>
                  <td th:text="${prov.email ?: '-'}">contacto@proveedor.com</td>
                  <td>
                    <span th:if="${prov.activo}" class="badge bg-success">Activo</span>
                    <span th:unless="${prov.activo}" class="badge bg-danger">Inactivo</span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-warning" 
                            th:onclick="|editarProveedor(${prov.id})|" 
                            title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <form th:action="@{/backoffice/admin/proveedores/eliminar/{id}(id=${prov.id})}" 
                          method="post" 
                          style="display:inline;"
                          onsubmit="return confirm('¿Eliminar este proveedor?')">
                      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                      <button class="btn btn-sm btn-danger" type="submit" title="Eliminar">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Nuevo Proveedor -->
    <div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalNuevoProveedorLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalNuevoProveedorLabel">
              <i class="fas fa-plus-circle"></i> Nuevo Proveedor
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form th:action="@{/backoffice/admin/proveedores/crear}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="newRazonSocial" class="form-label">Razón Social <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="newRazonSocial" name="razonSocial" required maxlength="200">
                </div>
                <div class="col-md-6">
                  <label for="newRuc" class="form-label">RUC <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="newRuc" name="ruc" required pattern="\d{11}" maxlength="11" 
                         title="Debe contener exactamente 11 dígitos">
                </div>
                <div class="col-md-12">
                  <label for="newDireccion" class="form-label">Dirección</label>
                  <input type="text" class="form-control" id="newDireccion" name="direccion" maxlength="200">
                </div>
                <div class="col-md-6">
                  <label for="newTelefono" class="form-label">Teléfono</label>
                  <input type="text" class="form-control" id="newTelefono" name="telefono" maxlength="15">
                </div>
                <div class="col-md-6">
                  <label for="newEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="newEmail" name="email" maxlength="100">
                </div>
                <div class="col-md-6">
                  <label for="newPersonaContacto" class="form-label">Persona de Contacto</label>
                  <input type="text" class="form-control" id="newPersonaContacto" name="personaContacto" maxlength="100">
                </div>
                <div class="col-md-6">
                  <label for="newActivo" class="form-label">Estado</label>
                  <select class="form-select" id="newActivo" name="activo">
                    <option value="true" selected>Activo</option>
                    <option value="false">Inactivo</option>
                  </select>
                </div>
                <div class="col-md-12">
                  <label for="newNotas" class="form-label">Notas</label>
                  <textarea class="form-control" id="newNotas" name="notas" rows="3" maxlength="500"></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Editar Proveedor -->
    <div class="modal fade" id="modalEditarProveedor" tabindex="-1" aria-labelledby="modalEditarProveedorLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalEditarProveedorLabel">
              <i class="fas fa-edit"></i> Editar Proveedor
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form id="formEditarProveedor" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="editRazonSocial" class="form-label">Razón Social <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="editRazonSocial" name="razonSocial" required maxlength="200">
                </div>
                <div class="col-md-6">
                  <label for="editRuc" class="form-label">RUC <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="editRuc" name="ruc" required pattern="\d{11}" maxlength="11">
                </div>
                <div class="col-md-12">
                  <label for="editDireccion" class="form-label">Dirección</label>
                  <input type="text" class="form-control" id="editDireccion" name="direccion" maxlength="200">
                </div>
                <div class="col-md-6">
                  <label for="editTelefono" class="form-label">Teléfono</label>
                  <input type="text" class="form-control" id="editTelefono" name="telefono" maxlength="15">
                </div>
                <div class="col-md-6">
                  <label for="editEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="editEmail" name="email" maxlength="100">
                </div>
                <div class="col-md-6">
                  <label for="editPersonaContacto" class="form-label">Persona de Contacto</label>
                  <input type="text" class="form-control" id="editPersonaContacto" name="personaContacto" maxlength="100">
                </div>
                <div class="col-md-6">
                  <label for="editActivo" class="form-label">Estado</label>
                  <select class="form-select" id="editActivo" name="activo">
                    <option value="true">Activo</option>
                    <option value="false">Inactivo</option>
                  </select>
                </div>
                <div class="col-md-12">
                  <label for="editNotas" class="form-label">Notas</label>
                  <textarea class="form-control" id="editNotas" name="notas" rows="3" maxlength="500"></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Actualizar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const proveedoresData = /*[[${proveedores}]]*/ [];

      function editarProveedor(id) {
        const proveedor = proveedoresData.find(p => p.id === id);
        if (!proveedor) return;

        document.getElementById('formEditarProveedor').action = `/backoffice/admin/proveedores/actualizar/${id}`;
        document.getElementById('editRazonSocial').value = proveedor.razonSocial || '';
        document.getElementById('editRuc').value = proveedor.ruc || '';
        document.getElementById('editDireccion').value = proveedor.direccion || '';
        document.getElementById('editTelefono').value = proveedor.telefono || '';
        document.getElementById('editEmail').value = proveedor.email || '';
        document.getElementById('editPersonaContacto').value = proveedor.personaContacto || '';
        document.getElementById('editActivo').value = proveedor.activo ? 'true' : 'false';
        document.getElementById('editNotas').value = proveedor.notas || '';

        new bootstrap.Modal(document.getElementById('modalEditarProveedor')).show();
      }

      // Limpiar búsqueda
      document.getElementById('btnLimpiarBusqueda').addEventListener('click', function() {
        document.getElementById('input-buscar-proveedor').value = '';
        window.location.href = '/backoffice/admin/proveedores';
      });

      // Limpieza global de modales
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('hidden.bs.modal', function() {
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          });
        });
      });
      /*]]>*/
    </script>
  </body>
</html>
